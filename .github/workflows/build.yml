name: Build IronVault

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Download OpenHarmony SDK
        run: |
          mkdir -p $HOME/openharmony-sdk
          cd $HOME/openharmony-sdk

          # Download OpenHarmony command-line tools from mirror
          wget -q --timeout=60 https://mirrors.huaweicloud.com/openharmony/6.0.0-RC1/standard_rc1_official_release/command_line_tools/linux/commandline-tools-linux-x64-6.0.0.47.zip
          unzip -q commandline-tools-linux-x64-6.0.0.47.zip
          rm commandline-tools-linux-x64-6.0.0.47.zip

          # Download toolchains
          mkdir -p commandline-tools/sdk/default/openharmony
          wget -q --timeout=60 https://mirrors.huaweicloud.com/openharmony/6.0.0-RC1/standard_rc1_official_release/compiler_and_runtime/linux/toolchains-linux-x64-6.0.0.47.zip
          unzip -q toolchains-linux-x64-6.0.0.47.zip -d commandline-tools/sdk/default/openharmony
          rm toolchains-linux-x64-6.0.0.47.zip

      - name: Configure Environment
        run: |
          export PATH=$HOME/openharmony-sdk/commandline-tools/bin:$PATH
          export HDC_HOME=$HOME/openharmony-sdk/commandline-tools/sdk/default/openharmony/toolchains
          echo "PATH=$PATH" >> $GITHUB_ENV
          echo "HDC_HOME=$HDC_HOME" >> $GITHUB_ENV

      - name: Configure npm for HarmonyOS
        run: |
          npm config set registry https://repo.huaweicloud.com/repository/npm/
          npm config set @ohos:registry https://repo.huaweicloud.com/repository/npm/

      - name: Install Dependencies
        run: |
          cd ${{ github.workspace }}
          npm install

      - name: Build HAP
        id: build
        run: |
          cd ${{ github.workspace }}
          export PATH=$HOME/openharmony-sdk/commandline-tools/bin:$PATH
          export HDC_HOME=$HOME/openharmony-sdk/commandline-tools/sdk/default/openharmony/toolchains

          # Try to build
          if [ -f "hvigorw" ]; then
            chmod +x hvigorw
            ./hvigorw assembleHap --mode module -p product=default --no-daemon
          else
            echo "Build skipped: hvigorw not configured"
          fi

      - name: Upload HAP Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ironvault-hap
          path: |
            entry/build/default/outputs/default/*.hap
            !**/node_modules/**
          retention-days: 7

      - name: List Build Outputs
        if: always()
        run: |
          ls -la ${{ github.workspace }}/entry/build/default/outputs/default/ 2>/dev/null || echo "No build outputs found"
