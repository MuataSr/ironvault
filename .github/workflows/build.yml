name: Build IronVault

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Download OpenHarmony SDK
        run: |
          mkdir -p $HOME/openharmony-sdk
          cd $HOME/openharmony-sdk

          # Download OpenHarmony command-line tools - try multiple mirrors
          echo "Downloading command-line tools..."
          if curl -L --connect-timeout 30 -o commandline-tools.zip "https://gitee.com/openharmony/commandline-tools/releases/download/v6.0.0/commandline-tools-linux-x64-6.0.0.47.zip" 2>&1; then
            unzip -q commandline-tools.zip
            rm commandline-tools.zip
          else
            echo "Failed to download from Gitee, trying alternative..."
            exit 1
          fi

          # Download toolchains
          echo "Downloading toolchains..."
          mkdir -p commandline-tools/sdk/default/openharmony
          if curl -L --connect-timeout 30 -o toolchains.zip "https://gitee.com/openharmony/commandline-tools/releases/download/v6.0.0/toolchains-linux-x64-6.0.0.47.zip" 2>&1; then
            unzip -q toolchains.zip -d commandline-tools/sdk/default/openharmony
            rm toolchains.zip
          else
            echo "Failed to download toolchains"
            exit 1
          fi

      - name: Configure Environment
        run: |
          export PATH=$HOME/openharmony-sdk/commandline-tools/bin:$PATH
          export HDC_HOME=$HOME/openharmony-sdk/commandline-tools/sdk/default/openharmony/toolchains
          echo "PATH=$PATH" >> $GITHUB_ENV
          echo "HDC_HOME=$HDC_HOME" >> $GITHUB_ENV

      - name: Configure npm for HarmonyOS
        run: |
          npm config set registry https://repo.huaweicloud.com/repository/npm/
          npm config set @ohos:registry https://repo.huaweicloud.com/repository/npm/

      - name: Install Dependencies
        run: |
          cd ${{ github.workspace }}
          npm install

      - name: Build HAP
        id: build
        run: |
          cd ${{ github.workspace }}
          export PATH=$HOME/openharmony-sdk/commandline-tools/bin:$PATH
          export HDC_HOME=$HOME/openharmony-sdk/commandline-tools/sdk/default/openharmony/toolchains

          # Try to build
          if [ -f "hvigorw" ]; then
            chmod +x hvigorw
            ./hvigorw assembleHap --mode module -p product=default --no-daemon
          else
            echo "Build skipped: hvigorw not configured"
          fi

      - name: Upload HAP Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ironvault-hap
          path: |
            entry/build/default/outputs/default/*.hap
            !**/node_modules/**
          retention-days: 7

      - name: List Build Outputs
        if: always()
        run: |
          ls -la ${{ github.workspace }}/entry/build/default/outputs/default/ 2>/dev/null || echo "No build outputs found"
